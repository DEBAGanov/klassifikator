# Template Rendering - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É —à–∞–±–ª–æ–Ω–æ–≤ –ª–µ–Ω–¥–∏–Ω–≥–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Handlebars.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [Handlebars —Å–∏–Ω—Ç–∞–∫—Å–∏—Å](#handlebars-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
- [–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã](#–∫–∞—Å—Ç–æ–º–Ω—ã–µ-—Ö–µ–ª–ø–µ—Ä—ã)
- [API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã](#api-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

## üéØ –û–±–∑–æ—Ä

Template Service –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Handlebars** –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML —à–∞–±–ª–æ–Ω–æ–≤ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Content Service.

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

```
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –∏–∑ –ë–î
2. –ö–æ–º–ø–∏–ª—è—Ü–∏—è Handlebars —à–∞–±–ª–æ–Ω–∞ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
3. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ Content Service
4. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ HTML —Å –¥–∞–Ω–Ω—ã–º–∏
5. –í–æ–∑–≤—Ä–∞—Ç –≥–æ—Ç–æ–≤–æ–≥–æ HTML
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **HandlebarsConfig** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–ª–ø–µ—Ä–æ–≤
2. **TemplateRenderService** - —Å–µ—Ä–≤–∏—Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
3. **WebClient** - –¥–ª—è –≤—ã–∑–æ–≤–∞ Content Service
4. **ConcurrentHashMap** - –∫—ç—à —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```gradle
implementation 'com.github.jknack:handlebars:4.3.1'
implementation 'com.github.jknack:handlebars-jackson2:4.3.1'
implementation 'org.springframework.boot:spring-boot-starter-webflux'
```

## üìù Handlebars —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```handlebars
{{title}}
{{organizationName}}
{{phone}}
```

### –£—Å–ª–æ–≤–∏—è

```handlebars
{{#if promotions}}
  <div class="promotions">
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  </div>
{{/if}}
```

### –¶–∏–∫–ª—ã

```handlebars
{{#each products}}
  <div class="product">
    <h3>{{name}}</h3>
    <p>{{description}}</p>
    <p class="price">{{price}} ‚ÇΩ</p>
  </div>
{{/each}}
```

### –í–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã

```handlebars
{{content.title}}
{{organization.name}}
```

## üîß –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã

### formatPrice

–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ü–µ–Ω—É —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á.

```handlebars
{{formatPrice price}}
<!-- –í—Ö–æ–¥: 50000 -->
<!-- –í—ã—Ö–æ–¥: 50 000 -->
```

### formatDate

–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY.

```handlebars
{{formatDate validTo}}
<!-- –í—Ö–æ–¥: 2025-11-30T23:59:59 -->
<!-- –í—ã—Ö–æ–¥: 30.11.2025 -->
```

### ifCond

–£—Å–ª–æ–≤–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏.

```handlebars
{{#ifCond price 10000 ">"}}
  <span class="expensive">–î–æ—Ä–æ–≥–æ</span>
{{else}}
  <span class="cheap">–î–æ—Å—Ç—É–ø–Ω–æ</span>
{{/ifCond}}
```

–û–ø–µ—Ä–∞—Ç–æ—Ä—ã: `==`, `!=`, `>`, `<`, `>=`, `<=`

### truncate

–û–±—Ä–µ–∑–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã.

```handlebars
{{truncate description 100}}
<!-- –û–±—Ä–µ–∂–µ—Ç –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –¥–æ–±–∞–≤–∏—Ç "..." -->
```

## üåê API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 1. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

```http
GET /api/v1/templates/{templateId}/render?organizationId={organizationId}
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –†–µ–Ω–¥–µ—Ä–∏—Ç —à–∞–±–ª–æ–Ω —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ Content Service.

**–ü—Ä–∏–º–µ—Ä**:
```bash
curl http://localhost:8083/api/v1/templates/1/render?organizationId=1
```

**–û—Ç–≤–µ—Ç**: HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (Content-Type: text/html)

### 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

```http
POST /api/v1/templates/{templateId}/render-with-data
Content-Type: application/json

{
  "title": "–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫",
  "organizationName": "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è",
  "products": [...]
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –†–µ–Ω–¥–µ—Ä–∏—Ç —à–∞–±–ª–æ–Ω —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

**–ü—Ä–∏–º–µ—Ä**:
```bash
curl -X POST http://localhost:8083/api/v1/templates/1/render-with-data \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–¢–µ—Å—Ç",
    "organizationName": "–ö–æ–º–ø–∞–Ω–∏—è",
    "phone": "+7 (900) 123-45-67"
  }'
```

### 3. –ö–æ–º–ø–∏–ª—è—Ü–∏—è —à–∞–±–ª–æ–Ω–∞

```http
POST /api/v1/templates/{templateId}/compile
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞.

**–ü—Ä–∏–º–µ—Ä**:
```bash
curl -X POST http://localhost:8083/api/v1/templates/1/compile
```

### 4. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

```http
DELETE /api/v1/templates/{templateId}/cache
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –£–¥–∞–ª—è–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –∏–∑ –∫—ç—à–∞.

**–ü—Ä–∏–º–µ—Ä**:
```bash
curl -X DELETE http://localhost:8083/api/v1/templates/1/cache
```

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —à–∞–±–ª–æ–Ω–∞

```bash
# 1. –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
curl -X POST http://localhost:8083/api/v1/templates \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Template",
    "htmlStructure": "<h1>{{title}}</h1><p>{{description}}</p>",
    "isActive": true
  }'

# 2. –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏
curl http://localhost:8083/api/v1/templates/1/render?organizationId=1
```

### –ü—Ä–∏–º–µ—Ä 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤

```handlebars
<div class="products">
  {{#each products}}
    <div class="product-card">
      <h3>{{name}}</h3>
      <p>{{description}}</p>
      {{#if imageUrl}}
        <img src="{{imageUrl}}" alt="{{name}}">
      {{/if}}
      <p class="price">{{formatPrice price}} ‚ÇΩ</p>
    </div>
  {{/each}}
</div>
```

### –ü—Ä–∏–º–µ—Ä 3: –£—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

```handlebars
{{#if promotions}}
  <section class="promotions">
    <h2>–ê–∫—Ü–∏–∏</h2>
    {{#each promotions}}
      <div class="promo">
        <h3>{{title}}</h3>
        <p>{{description}}</p>
        {{#if validTo}}
          <p>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {{formatDate validTo}}</p>
        {{/if}}
      </div>
    {{/each}}
  </section>
{{/if}}
```

## üöÄ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Ä–æ–≤–Ω–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ö–æ–º–ø–∏–ª—è—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤** - ConcurrentHashMap –≤ –ø–∞–º—è—Ç–∏
2. **–†–µ–Ω–¥–µ—Ä–∏–Ω–≥** - Redis –∫—ç—à (@Cacheable)

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º

```java
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
String html = templateRenderService.renderTemplate(1L, 1L);

// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è
templateRenderService.compileTemplate(1L);

// –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
templateRenderService.clearTemplateCache(1L);
```

### –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

–ö—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏:
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞ (PUT /api/v1/templates/{id})
- –£–¥–∞–ª–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞ (DELETE /api/v1/templates/{id})
- –†—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ (DELETE /api/v1/templates/{id}/cache)

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –î–∞–Ω–Ω—ã–µ, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ —à–∞–±–ª–æ–Ω–µ

```javascript
{
  // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  "title": "Title —Å—Ç—Ä–∞–Ω–∏—Ü—ã",
  "description": "Description",
  "h1": "–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫",
  "organizationName": "–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
  "organizationId": 1,
  
  // –ö–æ–Ω—Ç–∞–∫—Ç—ã
  "phone": "+7 (900) 123-45-67",
  "address": "–≥. –í–æ–ª–∂—Å–∫–∏–π, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 1",
  "website": "https://example.com",
  "workingHours": "–ü–Ω-–ü—Ç: 9:00-18:00",
  
  // –ö–æ–Ω—Ç–µ–Ω—Ç
  "aboutUs": "–¢–µ–∫—Å—Ç –æ –∫–æ–º–ø–∞–Ω–∏–∏",
  
  // –¢–æ–≤–∞—Ä—ã/—É—Å–ª—É–≥–∏
  "products": [
    {
      "id": 1,
      "name": "–£—Å–ª—É–≥–∞ 1",
      "description": "–û–ø–∏—Å–∞–Ω–∏–µ",
      "price": 50000,
      "imageUrl": "https://...",
      "isActive": true
    }
  ],
  
  // –ê–∫—Ü–∏–∏
  "promotions": [
    {
      "id": 1,
      "title": "–°–∫–∏–¥–∫–∞ 20%",
      "description": "–û–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ü–∏–∏",
      "imageUrl": "https://...",
      "validFrom": "2025-11-01T00:00:00",
      "validTo": "2025-11-30T23:59:59",
      "isActive": true
    }
  ]
}
```

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–¥–∏–Ω —Ä–∞–∑** - —à–∞–±–ª–æ–Ω—ã –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
2. **ConcurrentHashMap** - –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫—ç—à
3. **Redis –∫—ç—à** - –≥–æ—Ç–æ–≤—ã–π HTML –∫—ç—à–∏—Ä—É–µ—Ç—Å—è
4. **Lazy loading** - –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### –ú–µ—Ç—Ä–∏–∫–∏

- –ö–æ–º–ø–∏–ª—è—Ü–∏—è —à–∞–±–ª–æ–Ω–∞: ~50-100ms (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–∏–∑ –∫—ç—à–∞): ~5-10ms
- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (—Å –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö): ~100-200ms

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```yaml
logging:
  level:
    com.baganov.klassifikator.template: DEBUG
    com.github.jknack.handlebars: DEBUG
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
curl http://localhost:8082/api/v1/content/organization/1/full

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–±–ª–æ–Ω
curl http://localhost:8083/api/v1/templates/1
```

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø—É—Ç—å –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.

```handlebars
<!-- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ -->
{{title}}

<!-- –ü—Ä–∞–≤–∏–ª—å–Ω–æ, –µ—Å–ª–∏ title –≤–Ω—É—Ç—Ä–∏ content -->
{{content.title}}
```

### –ü—Ä–æ–±–ª–µ–º–∞: –¶–∏–∫–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ - —ç—Ç–æ –º–∞—Å—Å–∏–≤.

```javascript
// –ü—Ä–∞–≤–∏–ª—å–Ω–æ
{
  "products": [...]
}

// –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
{
  "products": {...}
}
```

### –ü—Ä–æ–±–ª–µ–º–∞: –•–µ–ª–ø–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ö–µ–ª–ø–µ—Ä–∞ –≤ HandlebarsConfig.

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Handlebars Documentation](https://handlebarsjs.com/)
- [Handlebars Java](https://github.com/jknack/handlebars.java)

---

**–í–µ—Ä—Å–∏—è**: 1.0.0  
**–î–∞—Ç–∞**: 2025-11-02  
**–ê–≤—Ç–æ—Ä**: Klassifikator Team

